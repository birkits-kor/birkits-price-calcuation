<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>버킷츠(birkits) 스마트 견적서</title>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root { --brand-color: #1a1a1a; --point-color: #3498db; --bg-color: #f2f4f7; --sale-color: #e67e22; }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: #333; -webkit-tap-highlight-color: transparent; }
        .header { background: white; padding: 20px; text-align: center; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.6rem; font-weight: 900; margin: 0; color: var(--brand-color); }
        .sub-logo { font-size: 0.85rem; color: #666; margin-top: 4px; font-weight: bold; }
        .content { padding: 20px; padding-bottom: 200px; max-width: 500px; margin: 0 auto; }
        .lineup-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 12px; background: white; font-weight: bold; cursor: pointer; transition:0.2s; }
        .tab-btn.active { border-color: var(--brand-color); background: var(--brand-color); color: white; }
        .section-title { font-size: 1rem; font-weight: 800; margin: 25px 0 10px 5px; color: var(--brand-color); border-left: 4px solid var(--point-color); padding-left: 10px; }
        .select-trigger { width: 100%; padding: 16px; background: white; border: 1px solid #e0e0e0; border-radius: 15px; text-align: left; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .trigger-set { border: 2px solid var(--sale-color); color: var(--sale-color); background: #fffaf0; }
        .item-row { background: #fff; padding: 18px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: start; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; }
        .brand-tag { font-size: 0.65rem; font-weight: 800; padding: 3px 6px; border-radius: 4px; margin-bottom: 6px; display: inline-block; }
        .tag-ma { background: #e8f4fd; color: #2980b9; }
        .tag-shuv { background: #fef9e7; color: #f39c12; }
        .set-desc { font-size: 0.75rem; color: #7f8c8d; margin-top: 5px; display: block; background: #f8f9fa; padding: 6px; border-radius: 6px; line-height: 1.3; }
        .price-group { margin-top: 5px; }
        .price-origin { text-decoration: line-through; color: #bbb; font-size: 0.8rem; margin-right: 5px; }
        .price-selling { color: #555; font-size: 0.85rem; font-weight: 600; margin-right: 5px; }
        .price-final { color: var(--sale-color); font-size: 1.05rem; font-weight: 900; display: block; margin-top: 2px; }
        .discount-badge { background: var(--sale-color); color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; margin-left: auto; }
        .info-card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-top: 10px; }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; font-size: 0.8rem; color: #777; margin-bottom: 5px; font-weight: 600; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 0.95rem; background: #fff; }
        .addr-btn { background: var(--brand-color); color: white; border: none; padding: 12px; border-radius: 10px; font-size: 0.85rem; cursor: pointer; width: 80px; }
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 20px; border-top: 1px solid #eee; z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); box-sizing: border-box; }
        .action-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn-action { flex: 1; padding: 15px; border-radius: 12px; font-weight: bold; border: none; color: white; background: var(--sale-color); font-size: 0.95rem; cursor: pointer; }
        .btn-secondary { background: #34495e; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: flex-end; }
        .modal-content { width: 100%; background: white; border-radius: 25px 25px 0 0; max-height: 85%; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .option-item { padding: 18px 0; border-bottom: 1px solid #f5f5f5; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .step-indicator { font-size: 0.85rem; color: var(--point-color); font-weight: bold; margin-bottom: 8px; display: block; }
        #receipt-temp { position: fixed; top: -9999px; left: -9999px; width: 380px; background: white; padding: 30px; border: 1px solid #eee; color: #333; }
        .receipt-h { border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; text-align: center; }
        .receipt-line { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 12px; align-items: flex-start; }
    </style>
</head>
<body>

<div class="header">
    <h1 class="logo">birkits</h1>
    <div class="sub-logo">버킷츠 스마트 견적서</div>
</div>

<div class="content">
    <div class="lineup-tabs">
        <button class="tab-btn active" id="tab-ma" onclick="switchLineup('ma')">Ma bed (마베드)</button>
        <button class="tab-btn" id="tab-shuv" onclick="switchLineup('shuv')">shuv (슈브)</button>
    </div>

    <div class="section-title">제품 견적 선택</div>
    <button class="select-trigger trigger-set" onclick="openSetModal()">⭐ 세트 상품 선택 (추가할인 적용) <span>+</span></button>
    <button class="select-trigger" onclick="openModal('frames')">단품: 프레임 <span>+</span></button>
    <button class="select-trigger" id="fabricBtn" style="display:none;" onclick="openModal('fabrics')">패브릭 컬러 (슈브 전용) <span>+</span></button>
    <button class="select-trigger" onclick="openModal('mattresses')">단품: 매트리스 <span>+</span></button>
    <button class="select-trigger" onclick="openModal('heads')">단품: 헤드 / 협탁 패키지 <span>+</span></button>
    <button class="select-trigger" onclick="openModal('tables')">단품: 테이블 <span>+</span></button>
    <button class="select-trigger" onclick="openModal('lights')">단품: 무드등 <span>+</span></button>
    <button class="select-trigger" onclick="openModal('delivery')">배송비 추가 (수도권 외) <span>+</span></button>

    <div id="itemList"></div>

    <div class="section-title">배송 정보 (선택)</div>
    <div class="info-card">
        <div class="input-group"><label>성함</label><input type="text" id="custName" placeholder="고객명"></div>
        <div class="input-group"><label>연락처</label><input type="tel" id="custPhone" placeholder="010-0000-0000"></div>
        <div class="input-group">
            <label>배송지 주소</label>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="text" id="custAddr" placeholder="주소 검색">
                <button class="addr-btn" onclick="execPostcode()">검색</button>
            </div>
            <input type="text" id="custAddrDetail" placeholder="상세 주소 입력">
        </div>
        <div class="input-group"><label>요청사항</label><textarea id="custMsg" rows="2" placeholder="배송 요청사항 등"></textarea></div>
    </div>
</div>

<div class="bottom-bar">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:bold; font-size:1.1rem;">총 견적 금액</span>
        <span style="font-size:1.6rem; font-weight:900; color:var(--sale-color);"><span id="totalDisplay">0</span>원</span>
    </div>
    <div class="action-group">
        <button class="btn-action btn-secondary" onclick="copyText()">텍스트 복사</button>
        <button class="btn-action" onclick="downloadImage()">이미지 저장</button>
    </div>
</div>

<div id="receipt-temp"></div>

<div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="step-indicator" id="stepIndicator"></span>
        <h3 id="modalTitle" style="margin:0 0 20px 0; border-bottom:1px solid #eee; padding-bottom:15px;">옵션 선택</h3>
        <div id="optionList"></div>
    </div>
</div>

<script src="data.js"></script>

<script>
let currentLineup = 'ma';
let selectedItems = [];

/* --- 기능 구현부 --- */

function switchLineup(l) { 
    currentLineup = l; 
    document.getElementById('tab-ma').classList.toggle('active', l === 'ma'); 
    document.getElementById('tab-shuv').classList.toggle('active', l === 'shuv');
    document.getElementById('fabricBtn').style.display = l === 'shuv' ? 'flex' : 'none';
}

function execPostcode() { 
    new daum.Postcode({ oncomplete: function(d) { 
        document.getElementById('custAddr').value = d.address; 
        document.getElementById('custAddrDetail').focus(); 
    }}).open(); 
}

// 1단계: 세트 종류
function openSetModal() {
    const l = document.getElementById('optionList'); 
    document.getElementById('modalTitle').innerText = "세트 종류 선택";
    document.getElementById('stepIndicator').innerText = "STEP 1/3";
    l.innerHTML = '';
    
    for (let setName in data[currentLineup].sets) {
        const set = data[currentLineup].sets[setName];
        const div = document.createElement('div'); div.className = 'option-item';
        div.onclick = () => selectSetSize(setName);
        div.innerHTML = `
            <div style="flex:1;">
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="font-weight:bold;">${setName}</span>
                    <span class="discount-badge">${set.d}% 추가할인</span>
                </div>
                <span class="set-desc">${set.o}</span>
            </div>
            <span style="color:#ccc;">❯</span>
        `;
        l.appendChild(div);
    }
    document.getElementById('modalOverlay').style.display = 'flex';
}

// 2단계: 사이즈
function selectSetSize(setName) {
    const l = document.getElementById('optionList'); 
    document.getElementById('modalTitle').innerText = `${setName} - 사이즈 선택`;
    document.getElementById('stepIndicator').innerText = "STEP 2/3";
    l.innerHTML = '';
    
    for (let size in data[currentLineup].sets[setName].sizes) {
        const div = document.createElement('div'); div.className = 'option-item';
        div.onclick = () => selectSetType(setName, size);
        div.innerHTML = `<span>${size} 사이즈</span><span style="color:#ccc;">❯</span>`;
        l.appendChild(div);
    }
}

// 3단계: 매트리스
function selectSetType(setName, size) {
    const l = document.getElementById('optionList'); 
    document.getElementById('modalTitle').innerText = "매트리스 타입 선택";
    document.getElementById('stepIndicator').innerText = "STEP 3/3";
    l.innerHTML = '';
    
    const p = data[currentLineup].sets[setName].sizes[size]; 
    const types = [{n:"하드", fp:p[2]}, {n:"미디움 하드", fp:p[3]}];
    
    types.forEach(type => {
        const div = document.createElement('div'); div.className = 'option-item';
        div.onclick = () => { 
            addItem(`${setName} ${size} (${type.n})`, type.fp, currentLineup, data[currentLineup].sets[setName].o, p[0]); 
            closeModal(); 
        };
        div.innerHTML = `
            <div style="flex:1;">
                <span style="font-weight:bold;">${type.n}</span>
                <div style="margin-top:5px;">
                    <span class="price-origin">₩${p[0].toLocaleString()}</span>
                    <span class="price-selling">판매가: ₩${p[1].toLocaleString()}</span>
                    <span class="price-final">최종가: ₩${type.fp.toLocaleString()}원</span>
                </div>
            </div>
        `;
        l.appendChild(div);
    });
}

// 단품/옵션 모달
function openModal(c) {
    const l = document.getElementById('optionList'); 
    document.getElementById('modalTitle').innerText = "옵션 추가";
    document.getElementById('stepIndicator').innerText = ""; 
    l.innerHTML = '';
    
    let opts = [];
    if(c === 'delivery') opts = deliveryData;
    else if(c === 'mattresses') opts = mattressData;
    else if(c === 'lights') opts = [{n:"무드등 한쪽", op:70000, p:35000}, {n:"무드등 양쪽", op:140000, p:70000}];
    else opts = data[currentLineup][c];
    
    opts.forEach(opt => {
        const div = document.createElement('div'); div.className = 'option-item';
        div.onclick = () => { addItem(opt.n, opt.p, currentLineup, "", opt.op); closeModal(); };
        div.innerHTML = `
            <div style="flex:1;">
                <span>${opt.n}</span>
                <div style="margin-top:2px;">
                    ${opt.op > 0 ? `<span class="price-origin">₩${opt.op.toLocaleString()}</span>` : ''}
                    <span style="font-weight:bold; color:#555;">₩${opt.p.toLocaleString()}원</span>
                </div>
            </div>
            <span style="color:var(--point-color); font-weight:bold;">+</span>
        `;
        l.appendChild(div);
    });
    document.getElementById('modalOverlay').style.display = 'flex';
}

function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
function addItem(n, p, b, d, op) { selectedItems.push({ id: Date.now(), name: `[${b === 'ma' ? '마베드' : '슈브'}] ${n}`, price: p, desc: d, origin: op }); render(); }
function removeItem(id) { selectedItems = selectedItems.filter(i => i.id !== id); render(); }

function render() {
    const list = document.getElementById('itemList'); list.innerHTML = ''; let t = 0;
    selectedItems.forEach(i => { t += i.price;
        list.innerHTML += `
            <div class="item-row">
                <div style="flex:1;">
                    <span class="brand-tag ${i.name.includes('마베드') ? 'tag-ma' : 'tag-shuv'}">${i.name.includes('마베드') ? 'MA BED' : 'SHUV'}</span>
                    <strong style="display:block; margin-top:5px;">${i.name.replace(/^\[.*?\]\s*/, '')}</strong>
                    ${i.desc ? `<span class="set-desc">구성: ${i.desc}</span>` : ''}
                    <div class="price-group">
                        ${i.origin > 0 ? `<span class="price-origin">₩${i.origin.toLocaleString()}</span>` : ''}
                        <span class="price-final">₩${i.price.toLocaleString()}원</span>
                    </div>
                </div>
                <button onclick="removeItem(${i.id})" style="border:none; background:none; font-size:1.5rem; color:#ccc; cursor:pointer;">×</button>
            </div>`;
    }); document.getElementById('totalDisplay').innerText = t.toLocaleString();
}

function copyText() {
    if(!selectedItems.length) return alert("선택된 품목이 없습니다.");
    const s = { n: document.getElementById('custName').value, p: document.getElementById('custPhone').value, a: document.getElementById('custAddr').value + " " + document.getElementById('custAddrDetail').value, m: document.getElementById('custMsg').value };
    const items = selectedItems.map(i => `- ${i.name} ${i.desc ? `(${i.desc})` : ''} : ${i.price.toLocaleString()}원`).join('\n');
    const txt = `[버킷츠 견적서]\n고객명: ${s.n}\n연락처: ${s.p}\n주소: ${s.a}\n\n${items}\n\n총 합계: ${document.getElementById('totalDisplay').innerText}원`;
    
    const t = document.createElement("textarea"); document.body.appendChild(t); t.value = txt; t.select(); document.execCommand('copy'); document.body.removeChild(t); 
    alert("견적 내역이 복사되었습니다!");
}

async function downloadImage() {
    if(!selectedItems.length) return alert("선택된 품목이 없습니다.");
    const r = document.getElementById('receipt-temp');
    const s = { n: document.getElementById('custName').value, p: document.getElementById('custPhone').value, a: document.getElementById('custAddr').value + " " + document.getElementById('custAddrDetail').value };
    
    let h = `<div class="receipt-h"><strong style="font-size:22px;">birkits</strong><br><span style="font-size:12px;">스마트 견적서</span></div><div style="margin-bottom:20px; font-size:12px; line-height:1.6; border-bottom:1px solid #eee; padding-bottom:15px;"><strong>고객명:</strong> ${s.n}<br><strong>연락처:</strong> ${s.p}<br><strong>주소:</strong> ${s.a}</div>`;
    selectedItems.forEach(i => { h += `<div class="receipt-line"><div style="flex:1;"><span style="font-weight:bold;">${i.name.replace(/^\[.*?\]\s*/, '')}</span>${i.desc ? `<br><span style="font-size:11px; color:#888;">${i.desc}</span>` : ''}</div><span style="font-weight:bold;">${i.price.toLocaleString()}</span></div>`; });
    h += `<div style="margin-top:20px; border-top:2px solid #333; padding-top:15px; display:flex; justify-content:space-between; font-weight:bold; font-size:18px; color:var(--sale-color);"><span>총 합계</span><span>${document.getElementById('totalDisplay').innerText}원</span></div>`;
    r.innerHTML = h;

    try {
        const canvas = await html2canvas(r, { scale: 2 });
        const link = document.createElement('a'); link.download = '견적서.png'; link.href = canvas.toDataURL(); link.click();
    } catch (e) { alert("저장 실패"); }
}
</script>
</body>
</html>
